<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8" />
<title>Rejestracja czasu pracy</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#ff9900">
<style>
/* Tu Twój CSS ze spinnerem, przyciskami itp. bez zmian */
body { background-color:black;color:orange;font-family:Arial,sans-serif;text-align:center;margin:0;padding:0;font-size:18px;}
.container{display:flex;flex-direction:column;align-items:center;justify-content:flex-end;min-height:100vh;padding:20px 20px 1000px;text-align:center;transform:scale(0.75) translateY(-10vh);transform-origin:top center;}
img.logo{max-width:90%;height:auto;margin-bottom:30px;}
select,button{width:100%;padding:16px;margin:12px 0;font-size:18px;border:none;border-radius:6px;}
select{background-color:#333;color:orange;}
button{background-color:orange;color:black;font-weight:bold;transition:all 0.1s ease;}
.button-row{display:flex;justify-content:space-between;gap:10px;margin-bottom:20px;}
.button-row button{flex:1;}
button:active{transform:scale(0.95);background-color:#ff9900;box-shadow:0 2px 4px rgba(0,0,0,0.5) inset;}
#status{margin-top:20px;font-size:16px;}
.status-box{margin-top:20px;font-size:20px;font-weight:bold;}
.spinner{border:10px solid #f3f3f3;border-top:10px solid orange;border-radius:50%;width:120px;height:120px;animation:spin 1s linear infinite;margin:30px auto 0;}
@keyframes spin{0%{transform:rotate(0deg);}100%{transform:rotate(360deg);}}
#loadingScreen{position:fixed;top:0;left:0;width:100vw;height:100vh;background:black;z-index:99999;display:flex;flex-direction:column;align-items:center;justify-content:center;}
#loadingScreen img{width:350px;max-width:80vw;margin-bottom:50px;}
#loadingScreen .spinner{width:120px;height:120px;margin:0;}
</style>
</head>
<body>

<div id="loadingScreen" style="display:none;">
  <img src="logo4.png" alt="Logo" />
  <div class="spinner"></div>
</div>

<div class="container">
<img src="logo4.png" alt="Logo" class="logo" />

<div class="button-row">
  <button id="btnSpawalniaStart" onclick="potwierdzSpawalnia('START')">ROZPOCZNIJ PRACĘ</button>
  <button id="btnSpawalniaStop" onclick="potwierdzSpawalnia('STOP')">ZAKOŃCZ PRACĘ</button>
</div>

<h2 id="projektyNaglowek">WYBIERZ PROJEKT</h2>
<select id="projekt">
  <option value="WP41 - 241011008">WP41 - 241011008</option>
  <option value="M3 - 241011006">M3 - 241011006</option>
  <option value="Area C - 241011011">Area C - 241011011</option>
  <option value="PGI Izolacja - 241011012">PGI Izolacja - 241011012</option>
  <option value="Lilly - 251011005">Lilly - 251011005</option>
  <option value="PGI Zbiornik - 251011002">PGI Zbiornik - 251011002</option>
  <option value="PGI Wyspa - 251011003">PGI Wyspa - 251011003</option>
</select>

<button id="btnStart" onclick="potwierdz('START')">START PROJEKT</button>
<button id="btnStop" onclick="potwierdz('STOP')">STOP PROJEKT</button>

<p id="status"></p>
<div class="status-box" id="projektInfo"></div>
<div id="loader" class="spinner" style="display: none;"></div>
</div>

<script>
// Twój JS do projektów/spawalni + geolokalizacji, spinnera, GET/POST (bez zmian)

const warsztaty = [
  { nazwa: "Warsztat 1", lat: 50.464580, lon: 17.945128 },
  { nazwa: "Warsztat 2", lat: 50.519695, lon: 18.306097 },
  { nazwa: "Warsztat 3", lat: 50.477306, lon: 17.951307 }
];
const API_URL = 'https://script.google.com/macros/s/TWOJ_APP_SCRIPT/exec';
let spawalniaActive = false;
let activeProject = "";
let manualLoading = false;

function getParam(name){ const params = new URLSearchParams(window.location.search); return params.get(name); }
function blokujPrzycisk(id){ const przycisk = document.getElementById(id); if(przycisk.disabled)return true; przycisk.disabled=true; setTimeout(()=>{przycisk.disabled=false;},15000); return false;}
function showLoading(show){document.getElementById('loadingScreen').style.display=show?'':'none';}
function showStatus(){const info=[]; if(spawalniaActive) info.push('Pracujesz na projekcie: Spawalnia'); if(activeProject) info.push('Pracujesz na projekcie: '+activeProject); document.getElementById('projektInfo').innerText=info.join('\n')||'Nie pracujesz na żadnym projekcie'; document.getElementById('btnSpawalniaStart').style.display=spawalniaActive?'none':''; document.getElementById('btnSpawalniaStop').style.display=spawalniaActive?'':'none'; const projektyWidoczne=spawalniaActive&&!activeProject; document.getElementById('projektyNaglowek').style.display=projektyWidoczne?'':'none'; document.getElementById('projekt').style.display=projektyWidoczne?'':'none'; document.getElementById('btnStart').style.display=projektyWidoczne?'':'none'; document.getElementById('btnStop').style.display=(spawalniaActive&&activeProject)?'':'none'; document.getElementById('btnStart').innerText='START PROJEKT'; document.getElementById('btnStop').innerText='STOP PROJEKT'; }
async function fetchStatusAndUpdate(showSpinner=false){if(showSpinner||manualLoading) showLoading(true); const userId=getParam('u')||'Nieznany'; try{ const res=await fetch(API_URL+?userId=${encodeURIComponent(userId)}); const status=await res.json(); spawalniaActive=!!status.spawalniaActive; activeProject=status.activeProject||""; showStatus(); showLoading(false); manualLoading=false;}catch(e){document.getElementById('status').innerText='❌ Błąd pobierania statusu'; showLoading(false); manualLoading=false;}}
window.onload=()=>{manualLoading=true; fetchStatusAndUpdate(true); setInterval(()=>fetchStatusAndUpdate(false),10000);}

function haversineDistance(lat1,lon1,lat2,lon2){const R=6371000;const toRad=x=>x*Math.PI/180;const dLat=toRad(lat2-lat1);const dLon=toRad(lon2-lon1);const a=Math.sin(dLat/2)*2+Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)*2;const c=2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));return R*c;}

function sprawdzLokalizacjeIZapisz(projekt,akcja,callback){showLoading(true);navigator.geolocation.getCurrentPosition(position=>{const userLat=position.coords.latitude; const userLon=position.coords.longitude; const wZasiegu=warsztaty.some(w=>{const dist=haversineDistance(userLat,userLon,w.lat,w.lon); return dist<=500;}); if(wZasiegu){wyslijDane(projekt,akcja,callback);}else{showLoading(false);document.getElementById('status').innerText='❌ Musisz być na warsztacie';}},error=>{showLoading(false);document.getElementById('status').innerHTML='❌ Wymagana lokalizacja. <br><br><button onclick="location.reload()">Kliknij tutaj, aby spróbować ponownie</button>';});}
async function wyslijDane(projekt,akcja,callback){const uzytkownik=getParam('u')||'Nieznany'; try{const dane={id:uzytkownik,projekt,akcja}; await fetch(API_URL,{method:'POST',mode:'no-cors',headers:{'Content-Type':'application/json'},body:JSON.stringify(dane)});document.getElementById('status').innerText='✅ DANE PRZESŁANE'; if(typeof callback==='function'){callback();}else{manualLoading=true; await fetchStatusAndUpdate(true);}}catch(e){showLoading(false);document.getElementById('status').innerText='❌ BŁĄD POŁĄCZENIA';}}
function potwierdz(akcja){const btnId=akcja==='START'?'btnStart':'btnStop';if(blokujPrzycisk(btnId))return; let projekt;if(akcja==='START'){projekt=document.getElementById('projekt').value; const potwierdzenie=confirm(Czy na pewno chcesz rozpocząć pracę na projekcie "${projekt}"?); if(potwierdzenie){manualLoading=true; sprawdzLokalizacjeIZapisz(projekt,'START');}}else{projekt=activeProject; const potwierdzenie=confirm(Czy na pewno chcesz zakończyć pracę na projekcie "${projekt}"?); if(potwierdzenie){manualLoading=true; sprawdzLokalizacjeIZapisz(projekt,'STOP');}}}
function potwierdzSpawalnia(akcja){const btnId=akcja==='START'?'btnSpawalniaStart':'btnSpawalniaStop';if(blokujPrzycisk(btnId))return; const potwierdzenie=confirm(Czy na pewno chcesz ${akcja==='START'?'rozpocząć':'zakończyć'} pracę na projekcie "Spawalnia"?); if(potwierdzenie){manualLoading=true;if(akcja==='STOP'&&activeProject){sprawdzLokalizacjeIZapisz(activeProject,'STOP',()=>{sprawdzLokalizacjeIZapisz("Spawalnia",'STOP');});}else{sprawdzLokalizacjeIZapisz("Spawalnia",akcja);}}}

// Rejestracja service workera i push
if('serviceWorker' in navigator){
  navigator.serviceWorker.register('sw.js')
    .then(reg=>console.log('SW zarejestrowany',reg))
    .catch(err=>console.log('Błąd rejestracji SW',err));
}

</script>
</body>
</html>
